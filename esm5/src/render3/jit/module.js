/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import { WrappedNodeExpr, compileNgModule as compileIvyNgModule, jitPatchDefinition } from '@angular/compiler';
import { flatten } from '../util';
import { angularCoreEnv } from './environment';
var EMPTY_ARRAY = [];
export function compileNgModule(type, ngModule) {
    var meta = {
        type: wrap(type),
        bootstrap: flatten(ngModule.bootstrap || EMPTY_ARRAY).map(wrap),
        declarations: flatten(ngModule.declarations || EMPTY_ARRAY).map(wrap),
        imports: flatten(ngModule.imports || EMPTY_ARRAY).map(expandModuleWithProviders).map(wrap),
        exports: flatten(ngModule.exports || EMPTY_ARRAY).map(expandModuleWithProviders).map(wrap),
        emitInline: true,
    };
    var res = compileIvyNgModule(meta);
    // Compute transitiveCompileScope
    var transitiveCompileScope = {
        directives: [],
        pipes: [],
    };
    flatten(ngModule.declarations || EMPTY_ARRAY).forEach(function (decl) {
        if (decl.ngPipeDef) {
            transitiveCompileScope.pipes.push(decl);
        }
        else if (decl.ngComponentDef) {
            transitiveCompileScope.directives.push(decl);
            patchComponentWithScope(decl, type);
        }
        else {
            transitiveCompileScope.directives.push(decl);
            decl.ngSelectorScope = type;
        }
    });
    function addExportsFrom(module) {
        module.ngModuleDef.exports.forEach(function (exp) {
            if (isNgModule(exp)) {
                addExportsFrom(exp);
            }
            else if (exp.ngPipeDef) {
                transitiveCompileScope.pipes.push(exp);
            }
            else {
                transitiveCompileScope.directives.push(exp);
            }
        });
    }
    flatten([(ngModule.imports || EMPTY_ARRAY), (ngModule.exports || EMPTY_ARRAY)])
        .filter(function (importExport) { return isNgModule(importExport); })
        .forEach(function (mod) { return addExportsFrom(mod); });
    jitPatchDefinition(type, 'ngModuleDef', res.expression, angularCoreEnv);
    type.ngModuleDef.transitiveCompileScope = transitiveCompileScope;
}
export function patchComponentWithScope(component, module) {
    component.ngComponentDef.directiveDefs = function () {
        return module.ngModuleDef.transitiveCompileScope.directives.map(function (dir) { return dir.ngDirectiveDef || dir.ngComponentDef; });
    };
    component.ngComponentDef.pipeDefs = function () {
        return module.ngModuleDef.transitiveCompileScope.pipes.map(function (pipe) { return pipe.ngPipeDef; });
    };
}
function expandModuleWithProviders(value) {
    if (isModuleWithProviders(value)) {
        return value.ngModule;
    }
    return value;
}
function wrap(value) {
    return new WrappedNodeExpr(value);
}
function isModuleWithProviders(value) {
    return value.ngModule !== undefined;
}
function isNgModule(value) {
    return value.ngModuleDef !== undefined;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvcmVuZGVyMy9qaXQvbW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFRQSxPQUFPLEVBQWlDLGVBQWUsRUFBRSxlQUFlLElBQUksa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUs3SSxPQUFPLEVBQUMsT0FBTyxFQUFDLE1BQU0sU0FBUyxDQUFDO0FBRWhDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFFN0MsSUFBTSxXQUFXLEdBQWdCLEVBQUUsQ0FBQztBQUVwQyxNQUFNLDBCQUEwQixJQUFlLEVBQUUsUUFBa0I7SUFDakUsSUFBTSxJQUFJLEdBQXVCO1FBQy9CLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQ2hCLFNBQVMsRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQy9ELFlBQVksRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLFlBQVksSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQ3JFLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzFGLE9BQU8sRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sSUFBSSxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBQzFGLFVBQVUsRUFBRSxJQUFJO0tBQ2pCLENBQUM7SUFDRixJQUFNLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMs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TyxLQUFLLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQztDQUNyQztBQUVELG9CQUFvQixLQUFVO0lBQzVCLE9BQU8sS0FBSyxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUM7Q0FDeEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7RXhwcmVzc2lvbiwgUjNOZ01vZHVsZU1ldGFkYXRhLCBXcmFwcGVkTm9kZUV4cHIsIGNvbXBpbGVOZ01vZHVsZSBhcyBjb21waWxlSXZ5TmdNb2R1bGUsIGppdFBhdGNoRGVmaW5pdGlvbn0gZnJvbSAnQGFuZ3VsYXIvY29tcGlsZXInO1xuXG5pbXBvcnQge01vZHVsZVdpdGhQcm92aWRlcnMsIE5nTW9kdWxlLCBOZ01vZHVsZURlZn0gZnJvbSAnLi4vLi4vbWV0YWRhdGEvbmdfbW9kdWxlJztcbmltcG9ydCB7VHlwZX0gZnJvbSAnLi4vLi4vdHlwZSc7XG5pbXBvcnQge0NvbXBvbmVudERlZn0gZnJvbSAnLi4vaW50ZXJmYWNlcy9kZWZpbml0aW9uJztcbmltcG9ydCB7ZmxhdHRlbn0gZnJvbSAnLi4vdXRpbCc7XG5cbmltcG9ydCB7YW5ndWxhckNvcmVFbnZ9IGZyb20gJy4vZW52aXJvbm1lbnQnO1xuXG5jb25zdCBFTVBUWV9BUlJBWTogVHlwZTxhbnk+W10gPSBbXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGNvbXBpbGVOZ01vZHVsZSh0eXBlOiBUeXBlPGFueT4sIG5nTW9kdWxlOiBOZ01vZHVsZSk6IHZvaWQge1xuICBjb25zdCBtZXRhOiBSM05nTW9kdWxlTWV0YWRhdGEgPSB7XG4gICAgdHlwZTogd3JhcCh0eXBlKSxcbiAgICBib290c3RyYXA6IGZsYXR0ZW4obmdNb2R1bGUuYm9vdHN0cmFwIHx8IEVNUFRZX0FSUkFZKS5tYXAod3JhcCksXG4gICAgZGVjbGFyYXRpb25zOiBmbGF0dGVuKG5nTW9kdWxlLmRlY2xhcmF0aW9ucyB8fCBFTVBUWV9BUlJBWSkubWFwKHdyYXApLFxuICAgIGltcG9ydHM6IGZsYXR0ZW4obmdNb2R1bGUuaW1wb3J0cyB8fCBFTVBUWV9BUlJBWSkubWFwKGV4cGFuZE1vZHVsZVdpdGhQcm92aWRlcnMpLm1hcCh3cmFwKSxcbiAgICBleHBvcnRzOiBmbGF0dGVuKG5nTW9kdWxlLmV4cG9ydHMgfHwgRU1QVFlfQVJSQVkpLm1hcChleHBhbmRNb2R1bGVXaXRoUHJvdmlkZXJzKS5tYXAod3JhcCksXG4gICAgZW1pdElubGluZTogdHJ1ZSxcbiAgfTtcbiAgY29uc3QgcmVzID0gY29tcGlsZUl2eU5nTW9kdWxlKG1ldGEpO1xuXG4gIC8vIENvbXB1dGUgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZVxuICBjb25zdCB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlID0ge1xuICAgIGRpcmVjdGl2ZXM6IFtdIGFzIGFueVtdLFxuICAgIHBpcGVzOiBbXSBhcyBhbnlbXSxcbiAgfTtcbiAgZmxhdHRlbihuZ01vZHVsZS5kZWNsYXJhdGlvbnMgfHwgRU1QVFlfQVJSQVkpLmZvckVhY2goZGVjbCA9PiB7XG4gICAgaWYgKGRlY2wubmdQaXBlRGVmKSB7XG4gICAgICB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlLnBpcGVzLnB1c2goZGVjbCk7XG4gICAgfSBlbHNlIGlmIChkZWNsLm5nQ29tcG9uZW50RGVmKSB7XG4gICAgICB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlLmRpcmVjdGl2ZXMucHVzaChkZWNsKTtcbiAgICAgIHBhdGNoQ29tcG9uZW50V2l0aFNjb3BlKGRlY2wsIHR5cGUgYXMgYW55KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZS5kaXJlY3RpdmVzLnB1c2goZGVjbCk7XG4gICAgICBkZWNsLm5nU2VsZWN0b3JTY29wZSA9IHR5cGU7XG4gICAgfVxuICB9KTtcblxuICBmdW5jdGlvbiBhZGRFeHBvcnRzRnJvbShtb2R1bGU6IFR5cGU8YW55PiYge25nTW9kdWxlRGVmOiBOZ01vZHVsZURlZjxhbnk+fSk6IHZvaWQge1xuICAgIG1vZHVsZS5uZ01vZHVsZURlZi5leHBvcnRzLmZvckVhY2goKGV4cDogYW55KSA9PiB7XG4gICAgICBpZiAoaXNOZ01vZHVsZShleHApKSB7XG4gICAgICAgIGFkZEV4cG9ydHNGcm9tKGV4cCk7XG4gICAgICB9IGVsc2UgaWYgKGV4cC5uZ1BpcGVEZWYpIHtcbiAgICAgICAgdHJhbnNpdGl2ZUNvbXBpbGVTY29wZS5waXBlcy5wdXNoKGV4cCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0cmFuc2l0aXZlQ29tcGlsZVNjb3BlLmRpcmVjdGl2ZXMucHVzaChleHApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZmxhdHRlbihbKG5nTW9kdWxlLmltcG9ydHMgfHwgRU1QVFlfQVJSQVkpLCAobmdNb2R1bGUuZXhwb3J0cyB8fCBFTVBUWV9BUlJBWSldKVxuICAgICAgLmZpbHRlcihpbXBvcnRFeHBvcnQgPT4gaXNOZ01vZHVsZShpbXBvcnRFeHBvcnQpKVxuICAgICAgLmZvckVhY2gobW9kID0+IGFkZEV4cG9ydHNGcm9tKG1vZCkpO1xuICBqaXRQYXRjaERlZmluaXRpb24odHlwZSwgJ25nTW9kdWxlRGVmJywgcmVzLmV4cHJlc3Npb24sIGFuZ3VsYXJDb3JlRW52KTtcbiAgKCh0eXBlIGFzIGFueSkubmdNb2R1bGVEZWYgYXMgTmdNb2R1bGVEZWY8YW55PikudHJhbnNpdGl2ZUNvbXBpbGVTY29wZSA9IHRyYW5zaXRpdmVDb21waWxlU2NvcGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXRjaENvbXBvbmVudFdpdGhTY29wZTxDLCBNPihcbiAgICBjb21wb25lbnQ6IFR5cGU8Qz4mIHtuZ0NvbXBvbmVudERlZjogQ29tcG9uZW50RGVmPEM+fSxcbiAgICBtb2R1bGU6IFR5cGU8TT4mIHtuZ01vZHVsZURlZjogTmdNb2R1bGVEZWY8TT59KSB7XG4gIGNvbXBvbmVudC5uZ0NvbXBvbmVudERlZi5kaXJlY3RpdmVEZWZzID0gKCkgPT5cbiAgICAgIG1vZHVsZS5uZ01vZHVsZURlZi50cmFuc2l0aXZlQ29tcGlsZVNjb3BlICEuZGlyZWN0aXZlcy5tYXAoXG4gICAgICAgICAgZGlyID0+IGRpci5uZ0RpcmVjdGl2ZURlZiB8fCBkaXIubmdDb21wb25lbnREZWYpO1xuICBjb21wb25lbnQubmdDb21wb25lbnREZWYucGlwZURlZnMgPSAoKSA9PlxuICAgICAgbW9kdWxlLm5nTW9kdWxlRGVmLnRyYW5zaXRpdmVDb21waWxlU2NvcGUgIS5waXBlcy5tYXAocGlwZSA9PiBwaXBlLm5nUGlwZURlZik7XG59XG5cbmZ1bmN0aW9uIGV4cGFuZE1vZHVsZVdpdGhQcm92aWRlcnModmFsdWU6IFR5cGU8YW55PnwgTW9kdWxlV2l0aFByb3ZpZGVycyk6IFR5cGU8YW55PiB7XG4gIGlmIChpc01vZHVsZVdpdGhQcm92aWRlcnModmFsdWUpKSB7XG4gICAgcmV0dXJuIHZhbHVlLm5nTW9kdWxlO1xuICB9XG4gIHJldHVybiB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gd3JhcCh2YWx1ZTogVHlwZTxhbnk+KTogRXhwcmVzc2lvbiB7XG4gIHJldHVybiBuZXcgV3JhcHBlZE5vZGVFeHByKHZhbHVlKTtcbn1cblxuZnVuY3Rpb24gaXNNb2R1bGVXaXRoUHJvdmlkZXJzKHZhbHVlOiBhbnkpOiB2YWx1ZSBpcyBNb2R1bGVXaXRoUHJvdmlkZXJzIHtcbiAgcmV0dXJuIHZhbHVlLm5nTW9kdWxlICE9PSB1bmRlZmluZWQ7XG59XG5cbmZ1bmN0aW9uIGlzTmdNb2R1bGUodmFsdWU6IGFueSk6IHZhbHVlIGlzIFR5cGU8YW55PiZ7bmdNb2R1bGVEZWY6IE5nTW9kdWxlRGVmPGFueT59IHtcbiAgcmV0dXJuIHZhbHVlLm5nTW9kdWxlRGVmICE9PSB1bmRlZmluZWQ7XG59XG4iXX0=